# Практическая работа №3.2: Настройка NGINX и Docker Swarm

## Цель работы

Настроить NGINX в качестве reverse proxy для микросервисов и развернуть приложение с использованием Docker Swarm для оркестрации контейнеров.

---

## Часть 1: Настройка NGINX как Reverse Proxy

### Шаг 1: Создание конфигурации NGINX

Создайте файл `nginx/nginx.conf`:

```nginx
upstream backend {
    server backend:3001;
}

upstream statistics {
    server statistics-service:3002;
}

upstream notifications {
    server notification-service:3003;
}

server {
    listen 80;
    server_name localhost;

    # Основной бэкенд API
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Микросервис статистики
    location /api/statistics/ {
        proxy_pass http://statistics;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Микросервис уведомлений
    location /api/notifications/ {
        proxy_pass http://notifications;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Фронтенд
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # Health checks
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### Шаг 2: Обновление docker-compose.yml для NGINX

Добавьте сервис NGINX в `docker-compose.yml`:

```yaml
  nginx:
    image: nginx:alpine
    container_name: coderacer-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./frontend/build:/usr/share/nginx/html
    depends_on:
      - backend
      - statistics-service
      - notification-service
      - frontend
    restart: unless-stopped
```

### Шаг 3: Запуск с NGINX

```bash
# Собрать фронтенд
cd frontend
npm run build
cd ..

# Запустить все сервисы
docker-compose up -d

# Проверить работу NGINX
curl http://localhost/api/statistics/overview
curl http://localhost/api/notifications/user/user_123
```

---

## Часть 2: Настройка Docker Swarm

### Шаг 1: Инициализация Docker Swarm

```bash
# Инициализировать Swarm (на главной ноде)
docker swarm init

# Сохраните токен для присоединения других нод
# Вывод команды будет содержать команду для присоединения воркеров
```

### Шаг 2: Создание Docker Stack файла

Создайте файл `docker-stack.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: coderacer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - coderacer-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  backend:
    image: coderacer-backend:latest
    environment:
      PORT: 3001
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: coderacer
      DB_USER: postgres
      DB_PASSWORD: postgres
      STATISTICS_SERVICE_URL: http://statistics-service:3002
      NOTIFICATION_SERVICE_URL: http://notification-service:3003
    networks:
      - coderacer-network
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure

  statistics-service:
    image: coderacer-statistics:latest
    environment:
      PORT: 3002
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: coderacer
      DB_USER: postgres
      DB_PASSWORD: postgres
    networks:
      - coderacer-network
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s

  notification-service:
    image: coderacer-notifications:latest
    environment:
      PORT: 3003
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: coderacer
      DB_USER: postgres
      DB_PASSWORD: postgres
    networks:
      - coderacer-network
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s

  frontend:
    image: coderacer-frontend:latest
    networks:
      - coderacer-network
    deploy:
      replicas: 2

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    networks:
      - coderacer-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

networks:
  coderacer-network:
    driver: overlay

volumes:
  postgres_data:
```

### Шаг 3: Подготовка Docker образов

```bash
# Собрать образы для всех сервисов
docker build -t coderacer-backend:latest ./backend
docker build -t coderacer-frontend:latest ./frontend
docker build -t coderacer-statistics:latest ./microservices/statistics-service
docker build -t coderacer-notifications:latest ./microservices/notification-service

# Или использовать docker-compose для сборки
docker-compose build
docker-compose push  # Если используете registry
```

### Шаг 4: Развертывание Stack в Swarm

```bash
# Развернуть stack
docker stack deploy -c docker-stack.yml coderacer

# Проверить статус сервисов
docker stack services coderacer

# Просмотр логов
docker service logs coderacer_backend
docker service logs coderacer_statistics-service
docker service logs coderacer_notification-service

# Масштабирование сервисов
docker service scale coderacer_backend=3
docker service scale coderacer_statistics-service=3
```

### Шаг 5: Обновление NGINX для балансировки нагрузки

Обновите `nginx/nginx.conf` для балансировки между репликами:

```nginx
upstream backend {
    least_conn;
    server backend:3001;
}

upstream statistics {
    least_conn;
    server statistics-service:3002;
}

upstream notifications {
    least_conn;
    server notification-service:3003;
}
```

---

## Часть 3: Мониторинг и управление

### Полезные команды Docker Swarm

```bash
# Просмотр всех сервисов
docker service ls

# Детальная информация о сервисе
docker service ps coderacer_backend

# Обновление сервиса
docker service update --image coderacer-backend:v2 coderacer_backend

# Откат обновления
docker service rollback coderacer_backend

# Удаление stack
docker stack rm coderacer

# Просмотр нод в Swarm
docker node ls

# Добавление меток к нодам
docker node update --label-add type=worker node1
```

### Проверка работы

```bash
# Проверить здоровье всех сервисов
curl http://localhost/health
curl http://localhost/api/statistics/overview
curl http://localhost/api/notifications/user/user_123

# Проверить балансировку нагрузки
for i in {1..10}; do curl http://localhost/api/health; done
```

---

## Часть 4: Добавление воркер-нод (опционально)

### На воркер-ноде:

```bash
# Присоединиться к Swarm (используйте токен из docker swarm init)
docker swarm join --token <TOKEN> <MANAGER_IP>:2377

# Проверить статус
docker node ls
```

### На менеджер-ноде:

```bash
# Просмотр всех нод
docker node ls

# Обновление роли ноды
docker node update --role manager <NODE_ID>
docker node update --role worker <NODE_ID>
```

---

## Результаты работы

После выполнения всех шагов вы должны иметь:

1. ✅ NGINX настроен как reverse proxy для всех микросервисов
2. ✅ Docker Swarm инициализирован и настроен
3. ✅ Все сервисы развернуты через Docker Stack
4. ✅ Настроена балансировка нагрузки между репликами
5. ✅ Приложение доступно через единую точку входа (порт 80)

---

## Дополнительные задания

1. Настройте SSL/TLS сертификаты для NGINX
2. Добавьте мониторинг через Prometheus и Grafana
3. Настройте автоматическое масштабирование на основе нагрузки
4. Реализуйте blue-green deployment для обновлений

---

## Устранение неполадок

### Проблема: Сервисы не могут подключиться друг к другу

**Решение:** Убедитесь, что все сервисы находятся в одной overlay сети:
```bash
docker network ls
docker network inspect coderacer-network
```

### Проблема: NGINX возвращает 502 Bad Gateway

**Решение:** Проверьте, что все сервисы запущены:
```bash
docker service ps coderacer_backend
docker service logs coderacer_backend
```

### Проблема: База данных недоступна

**Решение:** Убедитесь, что PostgreSQL запущен на менеджер-ноде:
```bash
docker service ps coderacer_postgres
```

