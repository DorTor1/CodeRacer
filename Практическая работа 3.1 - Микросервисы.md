# Практическая работа №3.1: Микросервисы

## Цель работы

Создать два микросервиса для проекта CodeRacer, настроить их Docker-контейнеризацию и интегрировать с основным приложением.

---

## Созданные микросервисы

### 1. Statistics Service (Порт 3002)

**Назначение:** Сбор и анализ статистики по гонкам пользователей.

**Функциональность:**
- Общая статистика по всем гонкам
- Статистика по языкам программирования
- Статистика конкретных пользователей
- Анализ трендов за период
- Анализ результатов гонок

**Endpoints:**
- `GET /health` - Проверка здоровья сервиса
- `GET /api/statistics/overview` - Общая статистика
- `GET /api/statistics/language/:language` - Статистика по языку
- `GET /api/statistics/user/:userId` - Статистика пользователя
- `GET /api/statistics/trends?days=7` - Тренды за N дней
- `POST /api/statistics/analyze` - Анализ результата гонки

### 2. Notification Service (Порт 3003)

**Назначение:** Отправка уведомлений о достижениях и рекордах.

**Функциональность:**
- Отправка уведомлений пользователям
- Проверка достижений (100+ WPM, идеальная точность и т.д.)
- Проверка рекордов по языкам программирования
- Хранение истории уведомлений

**Endpoints:**
- `GET /health` - Проверка здоровья сервиса
- `POST /api/notifications/send` - Отправить уведомление
- `GET /api/notifications/user/:userId` - Получить уведомления пользователя
- `POST /api/notifications/check-achievements` - Проверить достижения
- `POST /api/notifications/check-records` - Проверить рекорды
- `PUT /api/notifications/:id/read` - Отметить как прочитанное

---

## Структура проекта

```
microservices/
├── statistics-service/
│   ├── server.js          # Основной файл сервиса
│   ├── package.json       # Зависимости
│   ├── Dockerfile         # Docker образ
│   └── .dockerignore      # Исключения для Docker
├── notification-service/
│   ├── server.js          # Основной файл сервиса
│   ├── package.json       # Зависимости
│   ├── Dockerfile         # Docker образ
│   └── .dockerignore      # Исключения для Docker
└── README.md              # Документация
```

---

## Шаг 1: Проверка структуры микросервисов

Убедитесь, что все файлы созданы:

```bash
ls -la microservices/statistics-service/
ls -la microservices/notification-service/
```

---

## Шаг 2: Сборка Docker образов

### Вариант 1: Через docker-compose (рекомендуется)

```bash
# Собрать все сервисы включая микросервисы
docker-compose build

# Или собрать только микросервисы
docker-compose build statistics-service notification-service
```

### Вариант 2: Отдельная сборка каждого микросервиса

```bash
# Statistics Service
cd microservices/statistics-service
docker build -t coderacer-statistics:latest .

# Notification Service
cd ../notification-service
docker build -t coderacer-notifications:latest .
```

---

## Шаг 3: Запуск всех сервисов через Docker Compose

```bash
# Вернуться в корневую директорию проекта
cd /Users/dortor/Study/Devops/2\ task

# Запустить все сервисы
docker-compose up -d

# Проверить статус всех контейнеров
docker-compose ps
```

Ожидаемый вывод должен показывать 5 контейнеров:
- `coderacer-db` (PostgreSQL)
- `coderacer-backend` (Основной бэкенд)
- `coderacer-frontend` (Фронтенд)
- `coderacer-statistics` (Микросервис статистики)
- `coderacer-notifications` (Микросервис уведомлений)

---

## Шаг 4: Проверка работы микросервисов

### Проверка Statistics Service

```bash
# Проверка здоровья сервиса
curl http://localhost:3002/health

# Общая статистика
curl http://localhost:3002/api/statistics/overview

# Статистика по JavaScript
curl http://localhost:3002/api/statistics/language/javascript

# Статистика пользователя (замените user_123 на реальный ID)
curl http://localhost:3002/api/statistics/user/user_123

# Тренды за последние 7 дней
curl http://localhost:3002/api/statistics/trends?days=7
```

### Проверка Notification Service

```bash
# Проверка здоровья сервиса
curl http://localhost:3003/health

# Отправка тестового уведомления
curl -X POST http://localhost:3003/api/notifications/send \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test_user",
    "type": "achievement",
    "message": "Тестовое уведомление!",
    "data": {"badge": "test"}
  }'

# Получение уведомлений пользователя
curl http://localhost:3003/api/notifications/user/test_user

# Проверка достижений
curl -X POST http://localhost:3003/api/notifications/check-achievements \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test_user",
    "wpm": 120,
    "accuracy": 98,
    "totalRaces": 15
  }'
```

---

## Шаг 5: Проверка интеграции с основным бэкендом

Основной бэкенд автоматически вызывает микросервисы при сохранении результата гонки.

### Тестирование интеграции:

1. Откройте приложение в браузере: http://localhost
2. Завершите гонку
3. Проверьте логи микросервисов:

```bash
# Логи Statistics Service
docker-compose logs -f statistics-service

# Логи Notification Service
docker-compose logs -f notification-service

# Логи основного бэкенда
docker-compose logs -f backend
```

В логах должны появиться сообщения о вызовах микросервисов.

---

## Шаг 6: Проверка работы через фронтенд

1. Откройте http://localhost в браузере
2. Завершите несколько гонок
3. Проверьте профиль пользователя - статистика должна обновляться
4. Проверьте уведомления через API:

```bash
# Получить уведомления (используйте ваш userId из localStorage браузера)
curl http://localhost:3003/api/notifications/user/YOUR_USER_ID
```

---

## Дополнительные проверки

### Проверка сетевого взаимодействия между контейнерами

```bash
# Проверить, что контейнеры могут общаться друг с другом
docker exec coderacer-backend ping -c 3 statistics-service
docker exec coderacer-backend ping -c 3 notification-service
```

### Проверка подключения к базе данных

```bash
# Проверить подключение Statistics Service к БД
docker exec coderacer-statistics node -e "console.log('DB connection test')"

# Проверить подключение Notification Service к БД
docker exec coderacer-notifications node -e "console.log('DB connection test')"
```

---

## Результаты работы

После выполнения всех шагов вы должны иметь:

1. ✅ Два микросервиса созданы и работают
2. ✅ Dockerfile для каждого микросервиса создан
3. ✅ Docker Compose файл обновлен для запуска всех сервисов
4. ✅ Микросервисы успешно запущены в контейнерах
5. ✅ Микросервисы интегрированы с основным бэкендом
6. ✅ Все сервисы работают и обмениваются данными

---

## Устранение неполадок

### Проблема: Микросервисы не могут подключиться к базе данных

**Решение:** Убедитесь, что PostgreSQL запущен и доступен:
```bash
docker-compose ps postgres
docker-compose logs postgres
```

### Проблема: Основной бэкенд не может вызвать микросервисы

**Решение:** Проверьте, что микросервисы запущены и доступны по именам контейнеров:
```bash
docker-compose ps
docker exec coderacer-backend ping statistics-service
docker exec coderacer-backend ping notification-service
```

### Проблема: Порты заняты

**Решение:** Измените порты в `docker-compose.yml` или остановите процессы, использующие порты 3002 и 3003:
```bash
# Проверить, что использует порты
lsof -i :3002
lsof -i :3003
```

---

## Дополнительные задания

1. Добавьте больше endpoints в микросервисы
2. Реализуйте кэширование статистики
3. Добавьте очередь уведомлений (например, используя Redis)
4. Настройте мониторинг и логирование микросервисов
5. Добавьте аутентификацию для микросервисов

